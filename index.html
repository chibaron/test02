<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Web Serial Terminal</title>

  <style>
    body {
      background: #111;
      color: #0f0;
      font-family: monospace;
      margin: 20px;
    }

    h1 {
      color: #0f0;
    }

    .controls {
      margin-bottom: 10px;
    }

    button {
      background: #222;
      color: #0f0;
      border: 1px solid #0f0;
      padding: 5px 10px;
      cursor: pointer;
      margin-right: 5px;
    }

    button:disabled {
      opacity: 0.5;
    }

    #terminal {
      background: #000;
      border: 1px solid #0f0;
      height: 300px;
      overflow-y: auto;
      padding: 10px;
      white-space: pre-wrap;
    }

    #input {
      width: 100%;
      margin-top: 10px;
      background: #000;
      color: #0f0;
      border: 1px solid #0f0;
      padding: 5px;
    }

    .file-send {
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <h1>Web Serial Terminal</h1>

  <!-- 接続操作 -->
  <div class="controls">
    <button id="connect">Connect</button>
    <button id="disconnect" disabled>Disconnect</button>
  </div>

  <!-- ターミナル表示 -->
  <pre id="terminal"></pre>

  <!-- CLI入力 -->
  <input
    id="input"
    type="text"
    placeholder="Enter command..."
    disabled
  />

  <!-- ファイル送信 -->
  <div class="file-send">
    <input type="file" id="fileInput">
    <button id="sendFile" disabled>Send File</button>
  </div>

  <!-- JavaScript -->
  <script>
    let port;
    let reader;
    let writer;

    const terminal = document.getElementById("terminal");
    const input = document.getElementById("input");
    const connectBtn = document.getElementById("connect");
    const disconnectBtn = document.getElementById("disconnect");
    const fileInput = document.getElementById("fileInput");
    const sendFileBtn = document.getElementById("sendFile");

    const enc = new TextEncoder();
    const dec = new TextDecoder();

    const CHUNK_SIZE = 64; // 組み込み向け安全サイズ

    function log(text) {
      terminal.textContent += text;
      terminal.scrollTop = terminal.scrollHeight;
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    connectBtn.onclick = async () => {
      try {
        port = await navigator.serial.requestPort();
        await port.open({ baudRate: 115200 });

        writer = port.writable.getWriter();
        reader = port.readable.getReader();

        log("=== Connected ===\n");

        input.disabled = false;
        disconnectBtn.disabled = false;
        connectBtn.disabled = true;
        sendFileBtn.disabled = false;

        // 接続後1秒待って "#" を送信
        await sleep(1000);
        await writer.write(enc.encode("#"));
        log("> #\n");

        readLoop();
      } catch (e) {
        log(`Error: ${e}\n`);
      }
    };

    disconnectBtn.onclick = async () => {
      try {
        await reader.cancel();
        reader.releaseLock();
        writer.releaseLock();
        await port.close();
      } catch {}

      input.disabled = true;
      disconnectBtn.disabled = true;
      connectBtn.disabled = false;
      sendFileBtn.disabled = true;

      log("\n=== Disconnected ===\n");
    };

    async function readLoop() {
      while (true) {
        try {
          const { value, done } = await reader.read();
          if (done) break;
          if (value) {
            log(dec.decode(value));
          }
        } catch {
          break;
        }
      }
    }

    input.addEventListener("keydown", async (e) => {
      if (e.key === "Enter") {
        const text = input.value + "\n";
        input.value = "";
        await writer.write(enc.encode(text));
      }
    });

    sendFileBtn.onclick = async () => {
      if (!fileInput.files.length) {
        alert("ファイルを選択してください");
        return;
      }

      const file = fileInput.files[0];
      log(`\n=== Sending file: ${file.name} (${file.size} bytes) ===\n`);

      const buffer = await file.arrayBuffer();
      const data = new Uint8Array(buffer);

      for (let offset = 0; offset < data.length; offset += CHUNK_SIZE) {
        const chunk = data.slice(offset, offset + CHUNK_SIZE);
        await writer.write(chunk);

        log(`> sent ${offset + chunk.length}/${data.length}\n`);
        await sleep(10); // 受信側余裕
      }

      log("=== File send completed ===\n");
    };
  </script>
</body>
</html>

